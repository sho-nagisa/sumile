@using System.Globalization
@using sumile.Models
@using sumile.Services
@inject ShiftStatusDisplayService ShiftDisplay

@{
    ViewData["Title"] = "シフト一覧";

    var workloads = (ViewBag.Workloads as IEnumerable<DailyWorkload>)?.ToList()
                    ?? new List<DailyWorkload>();
    var recruitmentPeriods = ViewBag.RecruitmentPeriods as List<RecruitmentPeriod>;
    int? selectedPeriodId = ViewBag.SelectedPeriodId as int?;
    var users = (ViewBag.Users as IEnumerable<dynamic> ?? new List<dynamic>()).OrderBy(u => u.CustomId);
    var shiftDays = ViewBag.Dates as List<ShiftDay> ?? new List<ShiftDay>();
    var submissions = ViewBag.Submissions as IEnumerable<ShiftSubmission> ?? new List<ShiftSubmission>();
    var diffKeys = ViewBag.DiffKeys as HashSet<string> ?? new HashSet<string>();
    var totalAcceptedList = ViewBag.TotalAcceptedList as List<int> ?? new List<int>();
    var keyHolderAcceptedList = ViewBag.KeyHolderAcceptedList as List<int> ?? new List<int>();
    var remainingWorkersList = ViewBag.RemainingWorkersList as List<int> ?? new List<int>();
}

<h2>@ViewData["Title"]</h2>

<div class="mb-3">
    <a asp-action="Submission" controller="Shift" class="btn btn-primary">シフトを提出する</a>

    <form asp-controller="Account" asp-action="Logout" method="post" style="display:inline;">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn btn-danger">ログアウト</button>
    </form>

    <a href="@Url.Action("Index", "Exchange")" class="btn btn-info">シフト交換</a>
</div>

<!-- 期間選択 -->
<div class="mb-3">
    <label for="periodSelect">表示期間：</label>
    <select id="periodSelect" class="form-select" style="width:auto; display:inline;">
        @foreach (var rp in recruitmentPeriods)
        {
            <option value="@rp.Id" selected="@(rp.Id == selectedPeriodId)">
                @rp.StartDate.ToString("yyyy/MM/dd") ～ @rp.EndDate.ToString("yyyy/MM/dd")
            </option>
        }
    </select>
</div>

<script>
    document.getElementById('periodSelect')?.addEventListener('change', function () {
        location.href = '@Url.Action("Index", "Shift")?periodId=' + this.value;
    });
</script>

<style>
    .current-user-row { background-color: #f3e8ff; }
    .shift-none { color: gray; }
    .shift-accepted { color: black; }
    .shift-want { color: orange; }
    .shift-keyholder { color: red; }
    .highlight-cell { background-color: #fff3cd; }
</style>

<table class="table table-bordered text-center">
    <thead>
        <tr>
            <th rowspan="4">ユーザー</th>
            <th rowspan="4">鍵</th>
            @foreach (var day in shiftDays)
            {
                <th colspan="2">@day.Date.ToString("M/d")</th>
            }
        </tr>
        <tr>
            @foreach (var day in shiftDays)
            {
                <th colspan="2">@day.Date.ToString("ddd", new CultureInfo("ja-JP"))</th>
            }
        </tr>
        <tr>
            @foreach (var _ in shiftDays)
            {
                <th>上</th>
                <th>敷</th>
            }
        </tr>
        <tr>
            @foreach (var w in workloads)
            {
                <td colspan="2">@w.RequiredCount</td>
            }
        </tr>
    </thead>

    <tbody>
        @foreach (var user in users)
        {
            bool isCurrentUser = user.CustomId.ToString() == ViewBag.CurrentUserCustomId;
            <tr class="@(isCurrentUser ? "current-user-row" : "")">
                <td>@user.Name</td>
                <td>@(user.UserShiftRole == UserShiftRole.KeyHolder ? "★" : "")</td>

                @foreach (var day in shiftDays)
                {
                    var morning = submissions.FirstOrDefault(s =>
                        s.UserId == user.Id &&
                        s.ShiftDayId == day.Id &&
                        s.ShiftType == ShiftType.Morning);

                    var night = submissions.FirstOrDefault(s =>
                        s.UserId == user.Id &&
                        s.ShiftDayId == day.Id &&
                        s.ShiftType == ShiftType.Night);

                    var mKey = $"{user.Id}_{day.Id}_0";
                    var nKey = $"{user.Id}_{day.Id}_1";

                    var mDisplay = ShiftDisplay.GetDisplay(morning?.ShiftStatus);
                    var nDisplay = ShiftDisplay.GetDisplay(night?.ShiftStatus);

                    if (morning?.UserShiftRole == UserShiftRole.KeyHolder && mDisplay.Symbol == "〇")
                        mDisplay.CssClass += " shift-keyholder";

                    if (night?.UserShiftRole == UserShiftRole.KeyHolder && nDisplay.Symbol == "〇")
                        nDisplay.CssClass += " shift-keyholder";

                    <td class="@(diffKeys.Contains(mKey) ? "highlight-cell" : "") @mDisplay.CssClass">
                        @mDisplay.Symbol
                    </td>
                    <td class="@(diffKeys.Contains(nKey) ? "highlight-cell" : "") @nDisplay.CssClass">
                        @nDisplay.Symbol
                    </td>
                }
            </tr>
        }
    </tbody>

    <tfoot>
        <tr>
            <td colspan="2">〇</td>
            @foreach (var v in totalAcceptedList)
            {
                <td>@v</td>
            }
        </tr>
        <tr>
            <td colspan="2">赤丸</td>
            @foreach (var v in keyHolderAcceptedList)
            {
                <td>@v</td>
            }
        </tr>
        <tr>
            <td colspan="2">残り</td>
            @foreach (var v in remainingWorkersList)
            {
                <td>@v</td>
            }
        </tr>
    </tfoot>
</table>
